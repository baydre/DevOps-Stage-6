---
- name: Setup server and deploy application
  hosts: all
  become: true
  gather_facts: false
  vars_files:
    - vars/vault.yml

  tasks:
    - name: Wait for cloud-init to finish
      raw: cloud-init status --wait || true
      args:
        executable: /bin/bash
      changed_when: false
    
    - name: Install Docker and dependencies
      raw: |
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y docker.io docker-compose git
        systemctl start docker
        systemctl enable docker
        usermod -aG docker ubuntu
      args:
        executable: /bin/bash
      changed_when: false
    
    - name: Clone application repository
      raw: |
        cd /opt
        rm -rf app
        git clone https://github.com/baydre/DevOps-Stage-6.git app
        cd app
        git checkout main
      args:
        executable: /bin/bash
      changed_when: false
    
    - name: Start application with docker-compose
      raw: |
        cd /opt/app && ls -la && docker-compose -f docker-compose.yml up -d
      args:
        executable: /bin/bash
      changed_when: false

  post_tasks:
    - name: Display deployment information
      raw: echo "Application deployed successfully! Access at http://todoforge.mooo.com"
      args:
        executable: /bin/bash
      changed_when: false