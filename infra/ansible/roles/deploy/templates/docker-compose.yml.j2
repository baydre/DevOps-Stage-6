version: '3.8'

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - app-network
    ports:
      - "80:80"
      - "443:443"
      - "{{ traefik_dashboard_port }}:8080"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - {{ traefik_config_dir }}/traefik.yml:/traefik.yml:ro
      - {{ traefik_dynamic_config_dir }}:/config:ro
      - {{ ssl_certs_dir }}/acme.json:/letsencrypt/acme.json
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`{{ traefik_dashboard_host }}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.services.traefik.loadbalancer.server.port=888"

  frontend:
    build: ./frontend
    container_name: frontend
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - NODE_ENV=production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`{{ app_domain }}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    depends_on:
      - todos-api
      - users-api
      - auth-api

  todos-api:
    build: ./todos-api
    container_name: todos-api
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD={{ vault_db_password }}
      - DB_NAME=todosdb
      - JWT_SECRET={{ vault_jwt_secret }}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=guest
      - RABBITMQ_PASSWORD={{ vault_rabbitmq_password }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.todos-api.rule=Host(`{{ app_domain }}`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todos-api.entrypoints=websecure"
      - "traefik.http.routers.todos-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.todos-api.loadbalancer.server.port=3000"
    depends_on:
      - db
      - rabbitmq

  users-api:
    build: ./users-api
    container_name: users-api
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/usersdb
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD={{ vault_db_password }}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - JWT_SECRET={{ vault_jwt_secret }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.users-api.rule=Host(`{{ app_domain }}`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.users-api.entrypoints=websecure"
      - "traefik.http.routers.users-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.users-api.loadbalancer.server.port=8080"
    depends_on:
      - db

  auth-api:
    build: ./auth-api
    container_name: auth-api
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - PORT=8080
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD={{ vault_db_password }}
      - DB_NAME=authdb
      - JWT_SECRET={{ vault_jwt_secret }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-api.rule=Host(`{{ app_domain }}`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth-api.entrypoints=websecure"
      - "traefik.http.routers.auth-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.auth-api.loadbalancer.server.port=8080"
    depends_on:
      - db

  log-message-processor:
    build: ./log-message-processor
    container_name: log-message-processor
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=guest
      - RABBITMQ_PASSWORD={{ vault_rabbitmq_password }}
    depends_on:
      - rabbitmq

  db:
    image: postgres:13
    container_name: db
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD={{ vault_db_password }}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: unless-stopped
    networks:
      - app-network
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS={{ vault_rabbitmq_password }}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "15672:15672"  # Management UI

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  rabbitmq_data: