name: Application Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'auth-api/**'
      - 'frontend/**'
      - 'log-message-processor/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'docker-compose.yml'
      - '.github/workflows/application.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'auth-api/**'
      - 'frontend/**'
      - 'log-message-processor/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'docker-compose.yml'
  workflow_dispatch:

jobs:
  check-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      instance_ip: ${{ steps.get_instance.outputs.ip }}
      instance_exists: ${{ steps.get_instance.outputs.exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
        
    - name: Check Instance Exists
      id: get_instance
      run: |
        INSTANCE_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=devops-stage-6-instance-dev" \
          "Name=instance-state-name,Values=running" \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        
        if [ "$INSTANCE_IP" != "None" ] && [ -n "$INSTANCE_IP" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "âœ… Instance found at $INSTANCE_IP"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No running instance found. Run infrastructure deployment first."
          exit 1
        fi

  deploy-application:
    needs: check-infrastructure
    if: needs.check-infrastructure.outputs.instance_exists == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        # Verify key format
        if ! ssh-keygen -l -f ~/.ssh/deploy_key >/dev/null 2>&1; then
          echo "âŒ Invalid SSH key format in SSH_PRIVATE_KEY secret"
          echo "Please ensure the secret contains a valid RSA private key"
          exit 1
        fi
        echo "âœ… SSH key validated successfully"
        ssh-keyscan -H ${{ needs.check-infrastructure.outputs.instance_ip }} >> ~/.ssh/known_hosts
        
    - name: Pull Latest Code on Server
      run: |
        ssh -i ~/.ssh/deploy_key ubuntu@${{ needs.check-infrastructure.outputs.instance_ip }} << 'EOF'
          cd /opt/app
          # Backup .env before pulling (it's not in git, but ensure it's preserved)
          if [ -f .env ]; then
            sudo cp .env .env.backup
          fi
          sudo git pull origin main
          # Restore .env if it was backed up
          if [ -f .env.backup ]; then
            sudo mv .env.backup .env
          fi
        EOF
        
    - name: Restart Application
      run: |
        ssh -i ~/.ssh/deploy_key ubuntu@${{ needs.check-infrastructure.outputs.instance_ip }} << 'EOF'
          cd /opt/app
          sudo docker-compose down
          sudo docker-compose up -d
          echo "âœ… Application containers restarted"
        EOF
        
    - name: Wait for Application
      run: |
        echo "â³ Waiting for application to be ready..."
        sleep 30
        
    - name: Verify Deployment
      run: |
        INSTANCE_IP="${{ needs.check-infrastructure.outputs.instance_ip }}"
        
        # Check if containers are running
        CONTAINER_COUNT=$(ssh -i ~/.ssh/deploy_key ubuntu@$INSTANCE_IP \
          "sudo docker-compose -f /opt/app/docker-compose.yml ps --quiet | wc -l")
        
        echo "ðŸ“Š Running containers: $CONTAINER_COUNT"
        
        # Test frontend via domain name (Traefik uses Host-based routing)
        if curl -skL -H "Host: todoforge.mooo.com" https://$INSTANCE_IP/ | grep -q "frontend"; then
          echo "âœ… Frontend is responding (HTTPS)"
        else
          echo "âš ï¸ Direct HTTPS check failed, checking via SSH..."
          # Check if frontend container is actually running
          FRONTEND_STATUS=$(ssh -i ~/.ssh/deploy_key ubuntu@$INSTANCE_IP \
            "sudo docker ps --filter 'name=frontend' --format '{{.Status}}'")
          if [[ "$FRONTEND_STATUS" == *"Up"* ]]; then
            echo "âœ… Frontend container is running: $FRONTEND_STATUS"
          else
            echo "âŒ Frontend container is not running properly"
            exit 1
          fi
        fi
        
        # Test Traefik dashboard
        if curl -s -o /dev/null -w "%{http_code}" http://$INSTANCE_IP:8080 | grep -q "200\|401"; then
          echo "âœ… Traefik dashboard is accessible"
        else
          echo "âš ï¸ Traefik dashboard may not be accessible"
        fi
        
        echo "âœ… Application deployment verified successfully"

  rollback:
    needs: [check-infrastructure, deploy-application]
    if: failure() && needs.check-infrastructure.outputs.instance_exists == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        # Verify key format
        if ! ssh-keygen -l -f ~/.ssh/deploy_key >/dev/null 2>&1; then
          echo "âŒ Invalid SSH key format in SSH_PRIVATE_KEY secret"
          exit 1
        fi
        ssh-keyscan -H ${{ needs.check-infrastructure.outputs.instance_ip }} >> ~/.ssh/known_hosts
        
    - name: Rollback Application
      run: |
        ssh -i ~/.ssh/deploy_key ubuntu@${{ needs.check-infrastructure.outputs.instance_ip }} << 'EOF'
          cd /opt/app
          echo "ðŸ”„ Rolling back to previous version..."
          sudo git reset --hard HEAD~1
          sudo docker-compose down
          sudo docker-compose up -d
          echo "âœ… Rollback completed"
        EOF
